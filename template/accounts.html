{% extends "main_template.html" %}
{%load static%}

{% block title %} Accounts {% endblock %}
{% block stylesheet %}
<link rel="stylesheet" href="{% static 'css/accounts.css' %}"> {% endblock %}

{% block maincontent %}

<div class="accounts-container">
  <h2>Accounts</h2>

  <!-- Filters and Add Button -->

  <div class="accounts-header">
    <button class="filters-btn" data-filter="TertiaryFaculty" onclick="filterByUserType('TertiaryFaculty')">
      <span class="material-symbols-outlined">filter_list</span>
      Tertiary Faculty
    </button>
    <button class="filters-btn" data-filter="SystemUser" onclick="filterByUserType('SystemUser')">
      <span class="material-symbols-outlined">filter_list</span>
      System User
    </button>
    

    <select id="departmentFilter" onchange="filterByDepartment()">
      <option value="">All Departments</option>
      <option value="information technology">Information Technology</option>
      <option value="tourism">Tourism</option>
      <option value="business administration">Business Administration</option>
      <option value="criminology">Criminology</option>
      <option value="basic education">Basic Education</option>
    </select>

    <div class="search-container">
      <input type="text" class="search-input" id="searchInput" placeholder="Search accounts..." onkeyup="searchTable()">
      <button class="search-btn" onclick="searchTable()">
        <span class="material-symbols-outlined">search</span>
      </button>
    </div>

    

    <button class="add-teacher-btn" onclick="openModal()">
      <span class="material-symbols-outlined" style="font-size: 16px; margin-right: 5px;">add</span>
      Add User
    </button>

    <form id="importUserForm" enctype="multipart/form-data">
        <input type="hidden" name="csrfmiddlewaretoken" value="your-csrf-token">
        <input type="file" id="importUserFile" name="file" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
        
        <label for="importUserFile" class="import-user-btn">
            <span class="material-symbols-outlined">upload_file</span>
            Import Users
        </label>

        <span class="file-selected" id="fileSelected"></span>
    </form>

    <!-- Import results modal -->
    <div id="importResultsModal">
        <div class="modal-header">
            <h4>Import Results</h4>
            <button onclick="closeImportResults()" class="close-btn">&times;</button>
        </div>
        <div id="importResultsContent"></div>
    </div>

    <!-- Simple results modal/notification -->
    <div id="importResultsModal" style="display: none; position: fixed; top: 20px; right: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <h4 style="margin: 0;">Import Results</h4>
            <button onclick="closeImportResults()" style="border: none; background: none; cursor: pointer; font-size: 20px;">&times;</button>
        </div>
        <div id="importResultsContent"></div>
    </div>
  </div>

  <!-- Accounts Table -->
  {% if current_filter == 'TertiaryFaculty' %}
  <div class="accounts-table TertiaryFaculty">
    <table id="accountsTable">
      <thead>
        <tr>
          <th>Employee ID</th>
          <th>Name</th>
          <th>Department</th>
          <th>Employment Status</th>
          <th>Email</th>
          <th>Contact</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for professor in professors %}
        <tr data-professor-id="{{ professor.id }}" data-user-type="{{ professor.user_type }}"
          data-first-name="{{ professor.firstName }}" data-mid-name="{{ professor.midName }}"
          data-last-name="{{ professor.lastName }}" data-email="{{ professor.email }}"
          data-phone="{{ professor.phoneNumber }}" data-department="{{ professor.department }}"
          data-employment-status="{{ professor.employmentStatus }}" data-employ-id="{{ professor.employID }}">
          <td class="employID">{{professor.employID}}</td>
          <td class="user_name">{{ professor.full_name }}</td>
          <td class="user-department">{{ professor.department }}</td>
          <td class="user-employ-status">{{ professor.employmentstatus|default:"Full-time" }}</td>
          <td class="user-email">{{ professor.email }}</td>
          <td class="user-phone-number">{{ professor.phoneNumber }}</td>
          <td class="actions">
            <button title="Reset-password"
              onclick="resetPassword('{{professor.id}}', '{{professor.email}}', '{{professor.user_type}}')">
              <span class="material-symbols-outlined">lock</span>
            </button>
            <button title="Edit-info" class="edit-btn-action">
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button title="Delete" onclick="deleteUser('{{ professor.id }}', this)">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6">No users found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% elif current_filter == 'SystemUser' %}
<div class="accounts-table SystemUser">
    <table id="accountsTable">
      <thead>
        <tr>
          <th>Employee ID</th>
          <th>Name</th>
          <th>Role</th>
          <th>Email</th>
          <th>Contact</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for professor in professors %}
        <tr 
          data-professor-id="{{ professor.id }}" 
          data-user-type="{{ professor.user_type }}"
          data-first-name="{{ professor.firstName }}" 
          data-mid-name="{{ professor.midName }}"
          data-last-name="{{ professor.lastName }}" 
          data-email="{{ professor.email }}"
          data-phone="{{ professor.phoneNumber }}" 
          data-department="{{ professor.department }}"
          data-employment-status="{{ professor.employmentStatus }}" 
          data-employ-id="{{ professor.employID }}">
          <td class="employID">{{professor.employID}}</td>
          <td class="user_name">{{ professor.full_name }}</td>
          <td class="user-role">{{ professor.userRole }}</td>
          <td class="user-email">{{ professor.email }}</td>
          <td class="user-phone-number">{{ professor.phoneNumber }}</td>
          <td class="actions">
            <button title="Reset-password"
              onclick="resetPassword('{{professor.id}}', '{{professor.email}}', '{{professor.user_type}}')">
              <span class="material-symbols-outlined">lock</span>
            </button>
            <button title="Edit-info" class="edit-btn-action">
              <span class="material-symbols-outlined">edit</span>
            </button>
            <button title="Delete" onclick="deleteUser('{{ professor.id }}', this)">
              <span class="material-symbols-outlined">delete</span>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6">No users found</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{%endif%}


<!-- Add User Modal -->
<div class="modal" id="teacherModal">
  <div class="modal-content">
    <h3>Register User</h3>

    <label for="user-type">User Type: <span style="color: red;">*</span></label>
    <select required id="user-type" onchange="toggleUserTypeFields()">
      <option value="" disabled selected>Select User Type</option>
      <option value="TertiaryFaculty">Tertiary Faculty</option>
      <option value="SystemUser">System User</option>
    </select>

    <label for="employID">Employee ID <span style="color: red;">*</span></label>
    <input required type="text" id="employID" placeholder="Enter employee ID" maxlength="8" minlength="8">

    <label for="teacherEmail">Email Address<span style="color: red;">*</span></label>
    <input required type="email" id="teacherEmail" placeholder="Enter email address">

    <label for="teacherFirst">First Name <span style="color: red;">*</span></label>
    <input required type="text" id="teacherFirst" placeholder="Enter first name">

    <label for="teacherMiddle">Middle Name (Optional)</label>
    <input type="text" id="teacherMiddle" placeholder="Enter middle name">

    <label for="teacherLast">Last Name <span style="color: red;">*</span></label>
    <input required type="text" id="teacherLast" placeholder="Enter last name">

    <label for="teacherContact">Contact Number <span style="color: red;">*</span></label>
    <input required type="tel" id="teacherContact" placeholder="Enter contact number" maxlength="11" pattern="[0-9]{11}"
      title="Please enter exactly 11 digits">


    <div id="facultyFields" style="display: none;">
      <label for="teacherDept">Department <span style="color: red;">*</span></label>
      <select required id="teacherDept">
        <option value="" disabled selected>Select Department</option>
        <option value="Information Technology">Information Technology</option>
        <option value="Criminology">Criminology</option>
        <option value="Business Administration">Business Administration</option>
        <option value="Tourism Management">Tourism Management</option>
        <option value="Basic Education">Basic Education</option>
      </select>  
      <label for="employmentStatus">Employment Status <span style="color: red;">*</span></label>
      <select id="employmentStatus">
        <option value="" disabled selected>Select Status</option>
        <option value="Regular">Regular</option>
        <option value="Full-time">Full-time</option>
        <option value="Part-time">Part-time</option>
      </select>

    </div>


      <div id="systemUserFields" style="display: none;">
        <label for="userRole">User Role</label>
        <select id="userRole">
          <option value="staff/checker">Staff/Checker</option>
          <option value="admin">Admin</option>
        </select>
      </div>


    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeModal()">Cancel</button>
      <button class="save-btn" onclick="saveTeacher()">Add User</button>
    </div>
    <div style="margin-bottom: 20px;">

    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal" id="editTeacherModal">
  <div class="modal-content">
    <h3>Edit User Information</h3>

    <input type="hidden" id="editTeacherId">
    <input type="hidden" id="editUserType">

    <label for="editTeacherFirst">First Name <span style="color: red;">*</span></label>
    <input required type="text" id="editTeacherFirst" placeholder="Enter first name">

    <label for="editTeacherMiddle">Middle Name (Optional)</label>
    <input type="text" id="editTeacherMiddle" placeholder="Enter middle name">

    <label for="editTeacherLast">Last Name <span style="color: red;">*</span></label>
    <input required type="text" id="editTeacherLast" placeholder="Enter last name">

    <label for="editTeacherEmail">Email Address<span style="color: red;">*</span></label>
    <input required type="email" id="editTeacherEmail" placeholder="Enter email address" readonly
      style="background-color: #f0f0f0; cursor: not-allowed;">

    <label for="editTeacherContact">Contact Number <span style="color: red;">*</span></label>
    <input required type="tel" id="editTeacherContact" placeholder="Enter contact number" minlength="11" maxlength="11"
      pattern="[0-9]{11}" title="Please enter exactly 11 digits">

    <label for="editTeacherDept">Department <span style="color: red;">*</span></label>
    <select required id="editTeacherDept">
      <option value="" disabled>Select Department</option>
      <option value="Information Technology">Information Technology</option>
      <option value="Criminology">Criminology</option>
      <option value="Business Administration">Business Administration</option>
      <option value="Tourism">Tourism</option>
      <option value="Basic Education">Basic Education</option>
    </select>

    <!-- Fields for Tertiary Faculty Only -->
    <div id="editFacultyFields" style="display: none;">
      <label for="editEmploymentStatus">Employment Status <span style="color: red;">*</span></label>
      <select id="editEmploymentStatus">
        <option value="" disabled>Select Status</option>
        <option value="Regular">Regular</option>
        <option value="Full-time">Full-time</option>
        <option value="Part-time">Part-time</option>
      </select>

      <label for="editEmployID">Employee ID <span style="color: red;">*</span></label>
      <input type="text" id="editEmployID" placeholder="Enter employee ID"  maxlength="8" minlength="8">
    </div>

    <div class="modal-actions">
      <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
      <button class="save-btn" onclick="updateTeacher()">Update User</button>
    </div>
  </div>
</div>

<script src="{% static 'js/accounts.js' %}"></script>

{% endblock %}
{%block script_content%}
<script>
  async function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
            
    // Show selected file name
    const fileSelectedSpan = document.getElementById('fileSelected');
    fileSelectedSpan.textContent = file.name;
    fileSelectedSpan.classList.add('show');
            
    const formData = new FormData();
    formData.append('file', file);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
    try {
        // Replace with your actual endpoint
        const response = await fetch('/accounts/import-users-excel/', {
            method: 'POST',
            body: formData,
        });
        
        const data = await response.json();
                
        if (data.success) {
            showImportResults(`
                <p style="color: #28a745; margin-bottom: 10px;">
                    <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">check_circle</span>
                    ${data.message}
                </p>
                <small>${data.imported_count} users created${data.skipped_count > 0 ? `, ${data.skipped_count} skipped` : ''}</small>
            `);
              
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showImportResults(`
                <p style="color: #dc3545;">
                    <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">error</span>
                    ${data.error}
                </p>
            `);
        }
    } catch (error) {
        showImportResults(`
            <p style="color: #dc3545;">
                <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">error</span>
                Import failed: ${error.message}
            </p>
        `);
    }
            
    // Reset file input
    event.target.value = '';
    fileSelectedSpan.classList.remove('show');
  }

  function showImportResults(html) {
      document.getElementById('importResultsContent').innerHTML = html;
      document.getElementById('importResultsModal').style.display = 'block';
  }

  function closeImportResults() {
      document.getElementById('importResultsModal').style.display = 'none';
  }

  document.addEventListener("DOMContentLoaded", function () {
      initMobileAccordion();

      // Re-initialize on window resize
      let resizeTimer;
      window.addEventListener("resize", function () {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function () {
          initMobileAccordion();
        }, 250);
      });
    });

    function initMobileAccordion() {
      const isMobile = window.innerWidth <= 475;

      if (!isMobile) {
        // Clean up mobile elements if switching to desktop
        document.querySelectorAll(".card-header-mobile, .card-details-mobile").forEach(el => el.remove());
        document.querySelectorAll(".accounts-table tbody tr").forEach(row => {
          row.classList.remove("card-expanded");
        });
        return;
      }

      // Process each table row for mobile
      const tables = document.querySelectorAll("#accountsTable");

      tables.forEach(table => {
        const tbody = table.querySelector("tbody");
        if (!tbody) return;

        const rows = tbody.querySelectorAll("tr");
        const isSystemUser = table.closest('.SystemUser') !== null;

        rows.forEach(row => {
          // Skip if already has mobile structure
          if (row.querySelector(".card-header-mobile")) return;

          const cells = row.querySelectorAll("td");
          if (cells.length === 0) return;

          // Skip empty rows
          if (cells.length === 1 && cells[0].getAttribute('colspan')) return;

          // Get data from cells - with fallbacks
          const employeeId = cells[0] ? cells[0].textContent.trim() : 'N/A';
          const name = cells[1] ? cells[1].textContent.trim() : 'Unknown User';

          let detailsHTML = '';

          if (isSystemUser) {
            // System User table structure (6 columns)
            const role = cells[2] ? cells[2].textContent.trim() : 'N/A';
            const email = cells[3] ? cells[3].textContent.trim() : 'N/A';
            const contact = cells[4] ? cells[4].textContent.trim() : 'N/A';
            const actionsCell = cells[5];
            const actions = actionsCell ? actionsCell.innerHTML : '';

            detailsHTML = `
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Employee ID</span>
                        <span class="detail-value-mobile">${employeeId}</span>
                    </div>
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Role</span>
                        <span class="detail-value-mobile">${role}</span>
                    </div>
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Email</span>
                        <span class="detail-value-mobile">${email}</span>
                    </div>
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Contact</span>
                        <span class="detail-value-mobile">${contact}</span>
                    </div>
                    ${actions ? `
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Actions</span>
                        <span class="detail-value-mobile">
                            <div class="actions">${actions}</div>
                        </span>
                    </div>
                    ` : ''}
                `;
          } else {
            // Tertiary Faculty table structure (7 columns)
            const department = cells[2] ? cells[2].textContent.trim() : 'N/A';
            const employmentStatus = cells[3] ? cells[3].textContent.trim() : 'N/A';
            const email = cells[4] ? cells[4].textContent.trim() : 'N/A';
            const contact = cells[5] ? cells[5].textContent.trim() : 'N/A';
            const actionsCell = cells[6];
            const actions = actionsCell ? actionsCell.innerHTML : '';

            detailsHTML = `
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Employee ID</span>
                        <span class="detail-value-mobile">${employeeId}</span>
                    </div>
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Department</span>
                        <span class="detail-value-mobile">${department}</span>
                    </div>
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Employment</span>
                        <span class="detail-value-mobile">${employmentStatus}</span>
                    </div>
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Email</span>
                        <span class="detail-value-mobile">${email}</span>
                    </div>
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Contact</span>
                        <span class="detail-value-mobile">${contact}</span>
                    </div>
                    ${actions ? `
                    <div class="detail-row-mobile">
                        <span class="detail-label-mobile">Actions</span>
                        <span class="detail-value-mobile">
                            <div class="actions">${actions}</div>
                        </span>
                    </div>
                    ` : ''}
                `;
          }

          // Create mobile card header
          const cardHeader = document.createElement('div');
          cardHeader.className = 'card-header-mobile';
          cardHeader.innerHTML = `
                <span class="card-name-mobile">${name}</span>
                <button class="mobile-toggle-btn" type="button" aria-label="Toggle details">
                    <span class="material-symbols-outlined">expand_more</span>
                </button>
            `;

          // Create mobile card details
          const cardDetails = document.createElement('div');
          cardDetails.className = 'card-details-mobile';
          cardDetails.innerHTML = detailsHTML;

          // Insert at the beginning of the row
          row.insertBefore(cardHeader, row.firstChild);
          row.insertBefore(cardDetails, cardHeader.nextSibling);

          // Add click event to toggle
          const toggleBtn = cardHeader.querySelector('.mobile-toggle-btn');

          function toggleCard() {
            row.classList.toggle('card-expanded');
          }

          toggleBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            toggleCard();
          });

          // Make entire header clickable
          cardHeader.addEventListener('click', function (e) {
            if (e.target !== toggleBtn && !toggleBtn.contains(e.target)) {
              toggleCard();
            }
          });
        });
      });
    }
</script>
{%endblock%}