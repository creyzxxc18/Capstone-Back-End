{% extends "staff/staff_template.html" %}
{%load static%}
{% load tz %}

{% block title %} Staff Dashboard {% endblock %}
{% block stylesheet %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block maincontents %}

<div class="dashboard-container">
    <h2 style="text-transform: capitalize;">Attendance Dashboard</h2>
    <h5>Week of {{ week_start|date:"F j" }}-{{ week_end|date:"j, Y" }}</h5>
    <div class="dashboard-main-content">
        <div class="left-dashboard">

            <div class="stat-card">
                <div class="stat-left">
                    <div class="stat-icon present">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3>PRESENT:</h3>
                        <p>{{present_count}}</p>
                    </div>
                </div>
                <div class="chevron">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-left">
                    <div class="stat-icon absent">
                        <i class="fas fa-user-times"></i>
                    </div>
                    <div class="stat-info">
                        <h3>ABSENT:</h3>
                        <p>{{absent_count}}</p>
                    </div>
                </div>
                <div class="chevron">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-left">
                    <div class="stat-icon leave">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3>LATE:</h3>
                        <p>{{late_count}}</p>
                    </div>
                </div>
                <div class="chevron">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <div class="chart-container">
                <h3>Attendance Forecast</h3>
                {% if error %}
                <div style="color: red; padding: 20px; background: #fee2e2; border-radius: 8px;">
                    {{ error }}
                </div>
                {% elif original %}
                <canvas id="holtwinters-chart" height="220px"></canvas>
                {% else %}
                <div style="color: #666; padding: 20px;">
                    No attendance data available for analytics.
                </div>
                {% endif %}
            </div>
            <div class="cards-grid">
                <div class="insights-container insights-minimal">
                    <h3 style="text-transform: capitalize;">Attendance Insights</h3>

                    <div class="line"></div>

                    <div class="insights-list">
                        {%if insights%}
                        {%for insight in insights%}
                        <div class="insight-item">
                            <span class="insight-dot {{insight.type}}"></span>
                            <p><span class="insight-label {{insight.type}}">{{insight.label}}:</span>
                                {{insight.message}}</p>
                        </div>
                        {%endfor%}
                        {%else%}
                        <div class="insight-item">
                            <span class="insight-dot pattern"></span>
                            <p><span class="insight-label pattern">No Data:</span> Not enough attendance data for
                                insights</p>
                        </div>
                        {%endif%}
                    </div>
                    <div class="insights-footer">
                        <button class="view-logs-btn" onclick="openModal()">View Attendance Logs</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-dashboard">
            <div class="performer-card">
                <button onclick="openRankingsModal('top')"><i class="fa-solid fa-bars-staggered"></i>
                    <p>View Rankings</p>
                </button>
                <div class="performer-title">Top Performer</div>
                {%if top_performer%}
                <div class="performer-icon">
                    {% if poor_performer.profile_image %}
                    <img src="{{ poor_performer.profile_image }}" alt="{{ poor_performer.name }}"
                        class="performer-profile-img">
                    {% else %}
                    <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                <div class="performer-name">{{top_performer.name}}</div>
                <div class="performer-percentage">{{top_performer.rate}} %</div>
                <div class="performer-stats">
                    <small>{{ top_performer.present }}/{{ top_performer.total }} days present</small>
                </div>
                {%endif%}
            </div>

            <div class="performer-card">
                <button onclick="openRankingsModal('poor')"><i class="fa-solid fa-bars-staggered"></i>
                    <p>View Rankings</p>
                </button>
                <div class="performer-title">Poor Performer</div>
                {%if poor_performer%}
                <div class="performer-icon">
                    {% if poor_performer.profile_image %}
                    <img src="{{ poor_performer.profile_image }}" alt="{{ poor_performer.name }}"
                        class="performer-profile-img">
                    {% else %}
                    <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                <div class="performer-name">{{poor_performer.name}}</div>
                <div class="performer-percentage">{{poor_performer.rate}}</div>
                <div class="performer-stats">
                    <small>{{ poor_performer.present }}/{{ poor_performer.total }} days present</small>
                </div>
                {%endif%}
            </div>
            <div class="bar-chart-container">
                <h2>Department's Attendance Count</h2>
                {% if department %}

                <div class="chart-legend-top">
                    {% for dept in department %}
                    <div class="legend-item-bottom">
                        <div class="legend-box" style="background: {{ dept.color }};"></div>
                        <span style="text-transform: uppercase;">{{ dept.class }} ({{ dept.rate }})</span>
                    </div>
                    {% endfor %}
                </div>

                <div class="bar-chart">
                    <div class="chart-wrapper">

                        <div class="y-axis">
                            <div class="y-axis-label">Attendance Count</div>
                            {% for i in ticks%}
                            <div class="y-tick">{{i}}</div>
                            {%endfor%}
                        </div>

                        <div class="grid-container">
                            {% for i in tick_positions %}
                            <div class="grid-line" style="bottom: {{i}}%"></div>
                            {%endfor%}
                        </div>

                        <div class="bars-container">
                            {%for dept in department%}
                            <div class="bar-wrapper">
                                <div class="bar {{dept.class}}"
                                    style="--bar-height: {{dept.height}}%; background: {{dept.color}};"
                                    title="{{dept.name}}: {{dept.rate}}">
                                </div>
                            </div>
                            {%endfor%}
                        </div>

                        <div class="x-labels">
                            {%for dept in department%}
                            <div class="x-label">{{dept.name}}</div>
                            {%endfor%}
                        </div>

                        <div class="x-axis-title">College Departments</div>
                    </div>
                </div>
                {%endif%}
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="logsModal" onclick="closeModal('logsModal', event)">
        <div class="modal" onclick="event.stopPropagation()">

            <div class="modal-header">
                <h2>Attendance Logs</h2>
                <button class="close-btn" onclick="closeModal('logsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                {% if attendance %}
                {%for log in attendance %}
                <div class="log-item">
                    <div class="log-row">
                        <div class="log-name">{{log.teacherName}}</div>
                        <span class="log-status {{log.status}}"
                            style="text-transform: capitalize;">{{log.status}}</span>
                    </div>
                    <div class="log-info">{{log.subjectName}} - {{log.room}}</div>
                    {%if log.status == 'absent'%}
                    <div class="log-time">No Attendance Record</div>
                    {%else%}
                    <div class="log-time">Time In: {{log.timeIn}} | Time Out: {{log.timeOut}}</div>
                    {%endif%}
                </div>
                {%endfor%}
                {%else%}
                <h2>No Attendance Records</h2>
                {%endif%}
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="rankingsModal" onclick="closeModal('rankingsModal', event)">
        <div class="modal" onclick="event.stopPropagation()">

            <div class="modal-header">
                <h2 id="rankingsTitle">Attendance Rankings</h2>
                <button class="close-btn" onclick="closeModal('rankingsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body" id="rankingsBody">

            </div>
        </div>
    </div>
</div>

{% endblock %}

{%block script_content%}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function openModal() {
        document.getElementById('logsModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function openRankingsModal(type) {
        const modal = document.getElementById('rankingsModal');
        const title = document.getElementById('rankingsTitle');
        const body = document.getElementById('rankingsBody');

        if (type === 'top') {
            title.textContent = 'Top Performers';
            body.innerHTML = `
                    {% if top_rankers %}
                        {% for ranker in top_rankers reversed %}
                        <div class="rank-item {% if forloop.counter == 1 %}top-1{% elif forloop.counter == 2 %}top-2{% elif forloop.counter == 3 %}top-3{% endif %}">
                            <div class="rank-number">{{ forloop.counter }}</div>
                            <div class="rank-avatar">
                                {% if ranker.profile_image %}
                                    <img src="{{ ranker.profile_image }}" alt="{{ ranker.name }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                {% else %}
                                    {{ ranker.name|slice:":2"|upper }}
                                {% endif %}
                            </div>
                            <div class="rank-info">
                                <div class="rank-name">{{ ranker.name }}</div>
                                <div class="rank-dept">{{ ranker.department }}</div>
                            </div>
                            <div>
                                <div class="rank-rate">{{ ranker.rate }}%</div>
                                <div class="rank-stats">{{ ranker.present }}/{{ ranker.total }} days</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-trophy"></i>
                            <p>No ranking data available</p>
                        </div>
                    {% endif %}
                `;
        } else if (type === 'poor') {
            title.textContent = 'Poor Performers';
            body.innerHTML = `
                    {% if poor_rankers %}
                        {% for ranker in poor_rankers %}
                        <div class="rank-item {% if forloop.counter == 1 %}bottom-1{% elif forloop.counter == 2 %}bottom-2{% elif forloop.counter == 3 %}bottom-3{% endif %}">
                            <div class="rank-number">{{ forloop.counter }}</div>
                            <div class="rank-avatar">
                                {% if ranker.profile_image %}
                                    <img src="{{ ranker.profile_image }}" alt="{{ ranker.name }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                {% else %}
                                    {{ ranker.name|slice:":2"|upper }}
                                {% endif %}
                            </div>
                            <div class="rank-info">
                                <div class="rank-name">{{ ranker.name }}</div>
                                <div class="rank-dept">{{ ranker.department }}</div>
                            </div>
                            <div>
                                <div class="rank-rate">{{ ranker.rate }}%</div>
                                <div class="rank-stats">{{ ranker.present }}/{{ ranker.total }} days</div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-trophy"></i>
                            <p>No ranking data available</p>
                        </div>
                    {% endif %}
                `;
        }

        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId, event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            closeModal('logsModal');
            closeModal('rankingsModal');
        }
    });

    {% if original and smoothed and forecast %}
    const ctx = document.getElementById('holtwinters-chart');

    const weeks = {{ weeks| safe }};
    const original = {{ original| safe }};
    const smoothed = {{ smoothed| safe }};
    const forecast = {{ forecast| safe }};
    const allWeeks = [];
    weeks.forEach(w => allWeeks.push(w));
    for (let i = 1; i <= forecast.length; i++) {
        allWeeks.push((weeks[weeks.length - 1] + i));
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: allWeeks,
            datasets: [{
                label: 'Actual',
                data: [...original, ...Array(forecast.length).fill(null)],
                borderColor: '#a855f7',
                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                borderWidth: 3,
                pointRadius: 5,
                pointBackgroundColor: '#a855f7',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointHoverRadius: 7,
                tension: 0.4,
                fill: false
            }, {
                label: 'Smoothed',
                data: [...smoothed, ...Array(forecast.length).fill(null)],
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                borderWidth: 3,
                pointRadius: 5,
                pointBackgroundColor: '#06b6d4',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointHoverRadius: 7,
                tension: 0.4,
                fill: false
            }, {
                label: 'Forecast',
                data: [...Array(original.length).fill(null), ...forecast],
                borderColor: '#ec4899',
                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                borderWidth: 3,
                borderDash: [8, 4],
                pointRadius: 5,
                pointBackgroundColor: '#ec4899',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointHoverRadius: 7,
                pointStyle: 'circle',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        color: '#6b7280',
                        font: {
                            size: 13,
                            weight: '500'
                        },
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 15,
                        boxWidth: 8,
                        boxHeight: 8
                    }
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    titleColor: '#1f2937',
                    bodyColor: '#1f2937',
                    borderColor: '#d1d5db',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    titleFont: {
                        size: 13,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    callbacks: {
                        label: function (context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#6b7280',
                        font: { size: 12 },
                        padding: 8
                    },
                    grid: {
                        color: '#e5e7eb',
                        lineWidth: 1
                    },
                    border: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Weekly Attendance Count',
                        color: '#1f2937',
                        font: {
                            size: 13,
                            weight: '600'
                        },
                        padding: { top: 0, bottom: 10 }
                    }
                },
                x: {
                    min: Math.max(0, allWeeks.length - 10),
                    max: allWeeks.length - 1,
                    ticks: {
                        color: '#6b7280',
                        font: { size: 11 },
                        maxRotation: 45,
                        minRotation: 45,
                        padding: 10,
                        autoSkip: true,
                        maxTicksLimit: 10
                    },
                    grid: {
                        color: '#f3f4f6',
                        lineWidth: 1
                    },
                    border: {
                        display: false
                    }
                }
            },
            layout: {
                padding: {
                    bottom: 20
                }
            }
        }
    });
    {% endif %}
</script>

<script>
    const dropdown = document.querySelector('.dropdown');
</script>
{%endblock%}